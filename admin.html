<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin V34 | ØªØ®ØµÙŠØµ ÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-body: #0f172a; --bg-gradient: radial-gradient(circle at 50% 0%, #1e293b, #0f172a);
            --card-glass: rgba(30, 41, 59, 0.98); --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --danger: #ef4444; --border: rgba(255,255,255,0.08);
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); background-image: var(--bg-gradient); color: var(--text-main); font-family: 'Cairo', sans-serif; min-height: 100vh; padding-bottom: 100px; touch-action: pan-y; }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
        button:active, .cat-action:active, .header-btn:active, .fab-btn:active, .bulk-btn:active, .settings-menu-btn:active {
            transform: scale(0.94);
            transition: transform 0.1s;
        }

        header {
            position: sticky; top: 0; z-index: 1000; background: rgba(15, 23, 42, 0.98);
            border-bottom: 1px solid var(--border); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-btn {
            background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 12px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px;
            transition: 0.2s;
        }
        .header-btn.active { background: var(--primary); border-color: var(--primary); }

        .tabs-wrapper { position: sticky; top: 68px; z-index: 900; padding: 10px 0; background: linear-gradient(to bottom, rgba(15,23,42,1) 0%, rgba(15,23,42,0) 100%); }
        .tabs-container { display: flex; gap: 8px; overflow-x: auto; padding: 0 20px; scrollbar-width: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn {
            background: var(--card-glass); color: var(--text-muted); border: 1px solid var(--border);
            padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: 0.3s;
            font-family: 'Cairo'; font-weight: 700; font-size: 0.85rem; white-space: nowrap; flex-shrink: 0;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 10px 20px; max-width: 1000px; margin: 0 auto; }
        .card {
            background: var(--card-glass); border-radius: 18px; padding: 15px; border: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; position: relative; transition: transform 0.1s;
            touch-action: none;
        }
        
        .sortable-ghost { opacity: 0.4; background: var(--primary); }
        .sortable-drag { cursor: grabbing; opacity: 1; background: #1e293b; transform: scale(1.05); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        .card.selected { border: 2px solid var(--primary); background: rgba(59, 130, 246, 0.15); }
        .check-circle { 
            position: absolute; top: 10px; left: 10px; width: 22px; height: 22px; 
            border-radius: 50%; border: 2px solid #94a3b8; background: transparent; transition: 0.2s;
        }
        .card.selected .check-circle { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .card.selected .check-circle::after { content: 'âœ“'; color: white; font-size: 0.8rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .card img { width: 60px; height: 60px; border-radius: 14px; margin-bottom: 10px; object-fit: cover; pointer-events: none; }
        .card-title { font-size: 0.9rem; font-weight: 700; text-align: center; margin-bottom: 5px; height: 40px; overflow: hidden; pointer-events: none; }
        .edit-badge { position: absolute; top: 10px; left: 10px; background: #f59e0b; color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; }
        
        .drag-handle { 
            position: absolute; top: 0; right: 0; color: #94a3b8; cursor: grab; 
            padding: 15px; width: 50px; height: 50px; z-index: 10; font-size: 1.4rem; 
            display: flex; align-items: center; justify-content: center;
        }
        .drag-handle:active { color: var(--primary); }

        .fab-btn {
            position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px;
            background: var(--primary); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            cursor: pointer; z-index: 2000; border: none; transition: 0.3s;
        }

        #bulkBar {
            position: fixed; bottom: -120px; left: 0; width: 100%; 
            background: #1e293b; border-top: 1px solid var(--primary);
            padding: 15px 20px; z-index: 2500; display: flex; gap: 10px; 
            transition: 0.3s; box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
        }
        #bulkBar.visible { bottom: 0; }
        .bulk-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.8rem; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª (Z-Index) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        /* Ø¬Ø¹Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙˆÙ‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        #delCatModal, #alertModal { z-index: 4000 !important; }

        .modal-box { background: #1e293b; padding: 25px; border-radius: 20px; width: 90%; max-width: 380px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; max-height: 85vh; overflow-y: auto;}
        .modal-title { font-size: 1.2rem; color: white; margin-bottom: 10px; font-weight: bold; }
        .modal-desc { color: #94a3b8; font-size: 0.9rem; margin-bottom: 20px; line-height: 1.5; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; }
        .btn-full { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; font-family: 'Cairo'; margin-bottom: 5px; transition: 0.1s;}
        .btn-confirm { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-cancel { background: transparent; color: #94a3b8; border: 1px solid #334155; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: none; outline: none; font-size: 1rem; background: #334155; color: white; font-family: 'Cairo'; text-align: center; }
        
        .cat-item, .link-item { display: flex; gap: 8px; align-items: center; background: #334155; padding: 10px; margin-bottom: 8px; border-radius: 10px; border: 1px solid transparent;}
        .cat-item.locked { opacity: 0.6; filter: grayscale(1); border-color: #475569; }
        .cat-item.active-cat { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        
        .cat-drag { cursor: grab; font-size: 1.4rem; color: #94a3b8; padding: 0 10px; touch-action: none; }
        .cat-icon-input { width: 45px; margin: 0; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px; font-size: 1.2rem; }
        .cat-name-input { flex-grow: 1; margin: 0; background: transparent; text-align: right; padding: 8px; }
        .cat-action { padding: 8px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; color: white; }
        
        /* Ø³ÙˆÙŠØªØ´ Ø§Ù„Ù‚ÙÙ„ */
        .toggle-btn {
            width: 50px; height: 28px; background: #475569; border-radius: 50px; position: relative; cursor: pointer; transition: 0.3s;
        }
        .toggle-btn.on { background: var(--primary); }
        .toggle-btn::after {
            content: ''; position: absolute; top: 4px; left: 4px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle-btn.on::after { left: 26px; }

        .settings-menu-btn {
            display: flex; align-items: center; justify-content: space-between;
            background: #334155; color: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.05); font-weight: 600;
        }
        .settings-menu-btn:hover { background: #475569; }
        .settings-section { display: none; text-align: right; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙŠÙ‚ÙˆÙ†Ø§Øª */
        .icon-select {
            background: #334155; color: white; border: 1px solid #475569;
            padding: 8px; border-radius: 8px; font-size: 0.9rem;
            appearance: none; -webkit-appearance: none; text-align: center;
        }

    </style>
</head>
<body>

    <header>
        <div style="font-weight:900; font-size:1.2rem;">Admin<span style="color:#3b82f6">Panel</span></div>
        <div style="display:flex; gap:8px;">
            <button onclick="openSettingsModal()" class="header-btn" style="background: rgba(255,255,255,0.05);">
                <i class="fas fa-cog"></i> 
            </button>
            <button onclick="toggleSelectMode()" id="selectBtn" class="header-btn">
                <i class="fas fa-check-square"></i> ØªØ­Ø¯ÙŠØ¯
            </button>
            <button onclick="openCatModal()" class="header-btn">
                <i class="fas fa-folder"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            </button>
            <button onclick="login()" id="loginBtn" class="header-btn" style="background:#ea4335; border-color:#ea4335;">Login</button>
        </div>
    </header>

    <div class="tabs-wrapper">
        <div class="tabs-container" id="tabsList"></div>
    </div>

    <div class="grid" id="appsContainer">
        <div style="grid-column: span 2; text-align: center; color: #94a3b8; margin-top: 50px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <button class="fab-btn" id="addBtn" onclick="openEditModal()">+</button>

    <div id="bulkBar">
        <button class="bulk-btn" onclick="bulkMove()" style="background: #3b82f6;">
            <i class="fas fa-exchange-alt"></i> Ù†Ù‚Ù„
        </button>
        <button class="bulk-btn" onclick="bulkHide()" style="background: #f59e0b;">
            <i class="fas fa-eye-slash"></i> Ø­Ø§Ù„Ø©
        </button>
        <button class="bulk-btn" onclick="bulkDelete()" style="background: #ef4444;">
            <i class="fas fa-trash"></i> Ø­Ø°Ù
        </button>
    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-box">
            <div id="alertIcon" style="font-size:3rem; margin-bottom:10px;">âœ¨</div>
            <div id="alertTitle" class="modal-title">ØªÙ†Ø¨ÙŠÙ‡</div>
            <div id="alertMsg" class="modal-desc">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
            <button onclick="closeModal('alertModal')" class="btn-full btn-confirm">Ø­Ø³Ù†Ø§Ù‹</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 450px;">
            <div class="modal-title" style="margin-bottom:20px;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            
            <div id="settingsMain">
                <div class="settings-menu-btn" onclick="openSettingsSection('catLock')">
                    <span><i class="fas fa-lock-open" style="margin-left:10px; color:#3b82f6;"></i> Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                    <i class="fas fa-chevron-left"></i>
                </div>
                <div class="settings-menu-btn" onclick="openSettingsSection('sidebarEdit')">
                    <span><i class="fas fa-user-edit" style="margin-left:10px; color:#10b981;"></i> ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</span>
                    <i class="fas fa-chevron-left"></i>
                </div>
                <button onclick="closeModal('settingsModal')" class="btn-full btn-cancel" style="margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>

            <div id="catLockSection" class="settings-section">
                <div style="margin-bottom:15px; color:#94a3b8; font-size:0.85rem;">Ø§Ø¶ØºØ· Ù„Ù„Ù‚ÙÙ„/Ø§Ù„ÙØªØ­ (Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</div>
                <div id="catLockList" style="max-height:300px; overflow-y:auto;"></div>
                <button onclick="backToSettingsMain()" class="btn-full btn-cancel" style="margin-top:15px;">Ø±Ø¬ÙˆØ¹</button>
            </div>

            <div id="sidebarEditSection" class="settings-section">
                <div style="border-bottom:1px solid #334155; padding-bottom:15px; margin-bottom:15px;">
                    <div style="font-weight:bold; margin-bottom:10px; color:white;">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„ÙˆØµÙ</div>
                    <img id="profilePreview" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid #3b82f6; object-fit:cover; margin-bottom:10px;">
                    <button onclick="document.getElementById('profileImgInput').click()" class="btn-full btn-cancel" style="font-size:0.8rem;">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
                    <input type="file" id="profileImgInput" hidden accept="image/*" onchange="processProfileImage()">
                    
                    <div style="margin-top:10px; text-align:right;">
                        <label style="color:#94a3b8; font-size:0.8rem;">Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ÙˆØµÙ (Ø§Ù„Ø¨Ø§ÙŠÙˆ):</label>
                        <input type="text" id="profileBioInput" placeholder="Ø§ÙƒØªØ¨ Ø¹Ø¨Ø§Ø±Ø© ØªØ¸Ù‡Ø± ØªØ­Øª Ø§Ù„Ø§Ø³Ù…..." style="width:100%; margin-top:5px; background:#0f172a; border:1px solid #334155;">
                    </div>
                </div>
                
                <div style="font-weight:bold; margin-bottom:10px; color:white;">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</div>
                <div id="linksList" style="max-height:200px; overflow-y:auto; margin-bottom:10px;"></div>
                
                <button onclick="addNewLink()" class="btn-full" style="background:#334155; border:1px dashed #94a3b8; margin-bottom:10px;">+ Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯</button>
                <button onclick="saveSidebarSettings()" id="saveSidebarBtn" class="btn-full btn-confirm">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <button onclick="backToSettingsMain()" class="btn-full btn-cancel">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>
    </div>

    <div id="delCatModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="color:#ef4444">âš ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…</div>
            <div class="modal-desc">Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ Ø¨Ù…Ø­ØªÙˆÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ</div>
            <div class="modal-btns">
                <button onclick="confirmDelCat('ONLY')" class="btn-full btn-confirm">Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·</button>
                <button onclick="confirmDelCat('ALL')" class="btn-full btn-danger">Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… + Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</button>
                <button onclick="closeModal('delCatModal')" class="btn-full btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="appModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
            <select id="appCat"></select>
            <input type="text" id="appName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="appLink" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
            <button onclick="document.getElementById('fileInput').click()" class="btn-full btn-cancel" style="margin:10px 0;">ğŸ“¸ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="processImage()">
            <img id="previewImg" style="width:100%; max-height:200px; object-fit:contain; border-radius:10px; display:none; margin:10px 0; border:1px solid #334155;">
            
            <div style="display:flex; justify-content:space-between; margin:15px 0; color:#cbd5e1;">
                <span>Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ</span>
                <input type="checkbox" id="appHidden" style="width:20px;">
            </div>
            <div class="modal-btns">
                <button onclick="saveApp()" id="saveBtn" class="btn-full btn-confirm">Ø­ÙØ¸ ÙˆÙ†Ø´Ø±</button>
                <button onclick="deleteSingleApp()" id="delBtn" class="btn-full btn-danger" style="display:none;">Ø­Ø°Ù</button>
                <button onclick="closeModal('appModal')" class="btn-full btn-cancel">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <div id="catModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
            <div id="catList" style="max-height:250px; overflow-y:auto; margin-bottom:15px;"></div>
            <div style="border-top:1px solid #334155; padding-top:10px;">
                <input type="text" id="newCatIcon" placeholder="Ø±Ù…Ø²" style="width:20%; display:inline-block;">
                <input type="text" id="newCatName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…" style="width:75%; display:inline-block;">
                <input type="text" id="newCatID" placeholder="ID (Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙ‚Ø· - Ù„Ø§ ÙŠØªØºÙŠØ±)">
                <button onclick="addCategory()" class="btn-full btn-confirm" style="margin-top:5px;">+ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
            </div>
            <button onclick="closeModal('catModal')" class="btn-full btn-cancel" style="margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="moveModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ù†Ù‚Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</div>
            <div class="modal-desc">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:</div>
            <select id="moveTargetCat"></select>
            <button onclick="confirmBulkMove()" class="btn-full btn-confirm">Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù†</button>
            <button onclick="closeModal('moveModal')" class="btn-full btn-cancel" style="margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, update, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC_iEb4UhUREVJ2mfj00BounPVaeGQr7wI",
            authDomain: "mohammadalboushi-e9231.firebaseapp.com",
            projectId: "mohammadalboushi-e9231",
            databaseURL: "https://mohammadalboushi-e9231-default-rtdb.firebaseio.com/",
            appId: "1:236925802081:web:2e26094ab5ecdf988f3c20"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        const myUID = "eBOYmcmDI5S6l4NQd36bEa5kEcZ2";

        let allApps = {};
        let allCats = {};
        let currentImg = "";
        let editKey = null;
        let currentFilter = 'ALL';
        let isSelectMode = false;
        let selectedApps = new Set();
        let catToDelete = null;
        
        let appSortable = null;
        let catSortable = null;
        let linksSortable = null;
        let newProfileImg = "";

        const ICON_OPTIONS = [
            { val: "fab fa-whatsapp", label: "ÙˆØ§ØªØ³Ø§Ø¨", icon: "ğŸ’¬" },
            { val: "fas fa-phone", label: "Ø§ØªØµØ§Ù„", icon: "ğŸ“" },
            { val: "fab fa-facebook", label: "ÙÙŠØ³Ø¨ÙˆÙƒ", icon: "ğŸ“˜" },
            { val: "fab fa-instagram", label: "Ø§Ù†Ø³ØªØºØ±Ø§Ù…", icon: "ğŸ“¸" },
            { val: "fab fa-telegram", label: "ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", icon: "âœˆï¸" },
            { val: "fab fa-tiktok", label: "ØªÙŠÙƒ ØªÙˆÙƒ", icon: "ğŸµ" },
            { val: "fab fa-youtube", label: "ÙŠÙˆØªÙŠÙˆØ¨", icon: "â–¶ï¸" },
            { val: "fas fa-globe", label: "Ù…ÙˆÙ‚Ø¹ ÙˆÙŠØ¨", icon: "ğŸŒ" },
            { val: "fas fa-envelope", label: "Ø§ÙŠÙ…ÙŠÙ„", icon: "âœ‰ï¸" },
            { val: "fas fa-map-marker-alt", label: "Ù…ÙˆÙ‚Ø¹ Ø®Ø±ÙŠØ·Ø©", icon: "ğŸ“" }
        ];

        let sidebarData = {
            profileImg: "https://midomido.neocities.org/mohammadalboushi.png",
            bio: "Ù†Ø¨Ù†ÙŠ Ø§Ù„Ø£ÙÙƒØ§Ø±ØŒ ÙˆÙ†Ù†Ø¸Ù… Ø§Ù„ÙÙˆØ¶Ù‰ Ø§Ù„ØªÙ‚Ù†ÙŠØ©.",
            links: []
        };

        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === myUID) {
                document.getElementById('loginBtn').style.display = 'none';
                initSystem();
            }
        });
        window.login = () => signInWithPopup(auth, provider);

        function initSystem() {
            onValue(ref(db, 'categories'), (s) => {
                const val = s.val();
                if(!val) {
                    update(ref(db, 'categories'), {
                        'PROGRAM': { name: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª', icon: 'ğŸ“±', order: 1 },
                        'GAME': { name: 'Ø£Ù„Ø¹Ø§Ø¨', icon: 'ğŸ®', order: 2 }
                    });
                } else {
                    allCats = val;
                    renderTabs();
                    renderCatList();
                    if(document.getElementById('catLockSection').style.display === 'block') {
                        renderCatLockList();
                    }
                }
            });

            onValue(ref(db, 'apps'), (s) => {
                allApps = s.val() || {};
                renderApps();
            });

            onValue(ref(db, 'settings'), (s) => {
                const val = s.val();
                if(val) {
                    sidebarData = val;
                    if(!sidebarData.links) sidebarData.links = [];
                }
            });
        }

        function showAlert(title, msg, icon='âœ¨') {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            document.getElementById('alertModal').style.display = 'flex';
        }

        window.renderTabs = () => {
            const container = document.getElementById('tabsList');
            const select = document.getElementById('appCat');
            const sortedCats = Object.entries(allCats).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));

            let tabsHTML = `<button class="tab-btn ${currentFilter === 'ALL' ? 'active' : ''}" onclick="setFilter('ALL')">ğŸŒŸ Ø§Ù„ÙƒÙ„</button>`;
            let selectHTML = '';

            sortedCats.forEach(([key, val]) => {
                const hiddenStyle = val.isHidden ? 'opacity:0.6;' : '';
                const hiddenIcon = val.isHidden ? 'ğŸ”’' : '';
                
                tabsHTML += `<button class="tab-btn ${currentFilter === key ? 'active' : ''}" style="${hiddenStyle}" onclick="setFilter('${key}')">${hiddenIcon} ${val.icon} ${val.name}</button>`;
                selectHTML += `<option value="${key}">${val.name}</option>`;
            });

            container.innerHTML = tabsHTML;
            select.innerHTML = selectHTML;
        };

        window.setFilter = (f) => { currentFilter = f; renderTabs(); renderApps(); };

        function renderApps() {
            const container = document.getElementById('appsContainer');
            container.innerHTML = '';
            
            if (appSortable) { appSortable.destroy(); appSortable = null; }

            const sortedApps = Object.entries(allApps).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));

            sortedApps.forEach(([k, v]) => {
                if (currentFilter === 'ALL' || v.type === currentFilter) {
                    const isSelected = selectedApps.has(k) ? 'selected' : '';
                    const isHidden = v.isHidden ? 'opacity:0.5;' : '';
                    
                    const card = document.createElement('div');
                    card.className = `card ${isSelected}`;
                    card.style.cssText = isHidden;
                    card.setAttribute('data-key', k);
                    
                    card.onclick = (e) => {
                        if(e.target.classList.contains('drag-handle') || e.target.parentElement.classList.contains('drag-handle')) return;
                        if(isSelectMode) toggleSelection(k);
                        else openEditModal(k, v);
                    };
                    
                    card.innerHTML = `
                        <div class="check-circle"></div>
                        ${!isSelectMode ? '<span class="edit-badge">âœï¸ ØªØ¹Ø¯ÙŠÙ„</span>' : ''}
                        ${!isSelectMode && currentFilter === 'ALL' ? '<div class="drag-handle"><i class="fas fa-bars"></i></div>' : ''}
                        <img src="${v.img}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/564/564619.png'">
                        <div class="card-title">${v.name}</div>
                        <div style="font-size:0.7rem; color:#94a3b8;">${v.type}</div>
                    `;
                    container.appendChild(card);
                }
            });

            if (currentFilter === 'ALL' && !isSelectMode) {
                appSortable = new Sortable(container, {
                    handle: '.drag-handle', animation: 150, 
                    forceFallback: true, fallbackOnBody: true,
                    ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                    onEnd: () => {
                        const items = container.querySelectorAll('.card');
                        const updates = {};
                        items.forEach((item, index) => updates[`apps/${item.getAttribute('data-key')}/order`] = index);
                        update(ref(db), updates);
                    }
                });
            }
        }

        window.toggleSelectMode = () => {
            isSelectMode = !isSelectMode;
            selectedApps.clear();
            const btn = document.getElementById('selectBtn');
            const bulkBar = document.getElementById('bulkBar');
            const addBtn = document.getElementById('addBtn');
            
            if(isSelectMode) {
                btn.classList.add('active');
                bulkBar.classList.add('visible');
                addBtn.style.display = 'none';
            } else {
                btn.classList.remove('active');
                bulkBar.classList.remove('visible');
                addBtn.style.display = 'flex';
            }
            renderApps();
        };

        window.toggleSelection = (key) => {
            if(selectedApps.has(key)) selectedApps.delete(key);
            else selectedApps.add(key);
            const card = document.querySelector(`.card[data-key="${key}"]`);
            if(card) card.classList.toggle('selected');
        };

        function renderCatList() {
            const list = document.getElementById('catList');
            list.innerHTML = '';
            if (catSortable) { catSortable.destroy(); catSortable = null; }

            const sortedCats = Object.entries(allCats).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));

            sortedCats.forEach(([key, val]) => {
                const div = document.createElement('div');
                div.className = 'cat-item';
                div.setAttribute('data-id', key);
                div.innerHTML = `
                    <span class="cat-drag">â˜°</span>
                    <input type="text" class="cat-icon-input" value="${val.icon}" id="icon-${key}">
                    <input type="text" class="cat-name-input" value="${val.name}" id="name-${key}">
                    <i class="fas fa-save cat-action" onclick="saveCat('${key}')" style="color:#3b82f6;"></i>
                    <i class="fas fa-trash cat-action" onclick="tryDelCat('${key}')" style="color:#ef4444;"></i>
                `;
                list.appendChild(div);
            });

            catSortable = new Sortable(list, {
                handle: '.cat-drag', animation: 150, forceFallback: true,
                onEnd: () => {
                    const items = list.querySelectorAll('.cat-item');
                    const updates = {};
                    items.forEach((item, index) => updates[`categories/${item.getAttribute('data-id')}/order`] = index);
                    update(ref(db), updates);
                }
            });
        }

        window.saveCat = (key) => {
            const name = document.getElementById(`name-${key}`).value;
            const icon = document.getElementById(`icon-${key}`).value;
            update(ref(db, `categories/${key}`), { name, icon });
            showAlert("ØªÙ…", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ù…", "âœ…");
        };

        window.addCategory = () => {
            const name = document.getElementById('newCatName').value;
            const icon = document.getElementById('newCatIcon').value;
            const id = document.getElementById('newCatID').value.toUpperCase().replace(/\s/g, '_');
            if(!name || !id) return showAlert("Ø®Ø·Ø£", "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©", "âŒ");
            update(ref(db, `categories/${id}`), { name, icon: icon||'ğŸ“‚', order: 99, isHidden: false });
            document.getElementById('newCatName').value = '';
        };

        window.tryDelCat = (key) => { 
            catToDelete = key; 
            document.getElementById('delCatModal').style.display = 'flex'; 
        };
        
        window.confirmDelCat = (mode) => {
            if(mode === 'ALL') {
                const updates = {};
                Object.entries(allApps).forEach(([k, v]) => { if(v.type === catToDelete) updates[`apps/${k}`] = null; });
                updates[`categories/${catToDelete}`] = null;
                update(ref(db), updates);
                showAlert("ØªÙ… Ø§Ù„Ø­Ø°Ù", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª", "ğŸ—‘ï¸");
            } else {
                remove(ref(db, `categories/${catToDelete}`));
                showAlert("ØªÙ… Ø§Ù„Ø­Ø°Ù", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·", "âœ…");
            }
            closeModal('delCatModal');
        };

        window.openSettingsModal = () => {
            document.getElementById('settingsModal').style.display = 'flex';
            backToSettingsMain();
        };

        window.openSettingsSection = (sectionName) => {
            document.getElementById('settingsMain').style.display = 'none';
            document.querySelectorAll('.settings-section').forEach(el => el.style.display = 'none');
            
            if(sectionName === 'catLock') {
                document.getElementById('catLockSection').style.display = 'block';
                renderCatLockList();
            } else if (sectionName === 'sidebarEdit') {
                document.getElementById('sidebarEditSection').style.display = 'block';
                renderSidebarEdit();
            }
        };

        window.backToSettingsMain = () => {
            document.querySelectorAll('.settings-section').forEach(el => el.style.display = 'none');
            document.getElementById('settingsMain').style.display = 'block';
        };

        function renderCatLockList() {
            const list = document.getElementById('catLockList');
            list.innerHTML = '';
            
            const sortedCats = Object.entries(allCats).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));
            
            sortedCats.forEach(([key, val]) => {
                const isLocked = val.isHidden === true; 
                const div = document.createElement('div');
                div.className = `cat-item ${isLocked ? 'locked' : 'active-cat'}`;
                
                div.innerHTML = `
                    <div style="flex-grow:1; display:flex; align-items:center; gap:10px;">
                        <span>${val.icon}</span>
                        <span style="font-weight:bold;">${val.name}</span>
                        <span style="font-size:0.7rem; color:${isLocked ? '#94a3b8' : '#10b981'}">
                            ${isLocked ? '(Ù…Ø®ÙÙŠ)' : '(Ø¸Ø§Ù‡Ø±)'}
                        </span>
                    </div>
                    <div id="toggle-${key}" class="toggle-btn ${!isLocked ? 'on' : ''}" onclick="toggleCatStatus('${key}', ${isLocked})"></div>
                `;
                list.appendChild(div);
            });
        }

        window.toggleCatStatus = (key, currentStatus) => {
            const btn = document.getElementById(`toggle-${key}`);
            if(btn) btn.classList.toggle('on');
            update(ref(db, `categories/${key}`), { isHidden: !currentStatus });
        };

        function renderSidebarEdit() {
            newProfileImg = sidebarData.profileImg || "https://midomido.neocities.org/mohammadalboushi.png";
            document.getElementById('profilePreview').src = newProfileImg;

            // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø§ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            document.getElementById('profileBioInput').value = sidebarData.bio || "Ù†Ø¨Ù†ÙŠ Ø§Ù„Ø£ÙÙƒØ§Ø±ØŒ ÙˆÙ†Ù†Ø¸Ù… Ø§Ù„ÙÙˆØ¶Ù‰ Ø§Ù„ØªÙ‚Ù†ÙŠØ©.";

            const list = document.getElementById('linksList');
            list.innerHTML = '';
            
            const links = sidebarData.links || [];
            
            links.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = 'link-item';
                
                let optionsHtml = '<option value="">Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹...</option>';
                ICON_OPTIONS.forEach(opt => {
                    optionsHtml += `<option value="${opt.val}">${opt.icon} ${opt.label}</option>`;
                });

                div.innerHTML = `
                    <span class="cat-drag"><i class="fas fa-bars"></i></span>
                    
                    <div style="width:35%; display:flex; flex-direction:column; gap:5px;">
                        <input type="text" class="link-icon-input" id="icon-input-${index}" value="${link.icon}" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø§ÙŠÙ‚ÙˆÙ†Ø©" style="width:100%; margin:0; padding:5px; font-size:0.8rem; text-align:left;">
                        <select class="icon-select" onchange="document.getElementById('icon-input-${index}').value = this.value" style="width:100% !important; margin:0; padding:2px; font-size:0.8rem; height:25px;">
                            ${optionsHtml}
                        </select>
                    </div>

                    <div style="flex-grow:1; display:flex; flex-direction:column; gap:2px;">
                        <input type="text" class="link-name" value="${link.name}" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin:0; padding:5px; font-size:0.9rem;">
                        <input type="text" class="link-url" value="${link.url}" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·" style="margin:0; padding:5px; font-size:0.8rem; direction:ltr;">
                    </div>
                    <i class="fas fa-trash" style="color:#ef4444; cursor:pointer; padding:5px;" onclick="removeLink(${index})"></i>
                `;
                list.appendChild(div);
            });

            if(linksSortable) linksSortable.destroy();
            linksSortable = new Sortable(list, { handle: '.cat-drag', animation: 150 });
        }

        window.processProfileImage = () => {
             const f = document.getElementById('profileImgInput').files[0]; 
            if(f){ 
                const r=new FileReader(); r.readAsDataURL(f); 
                r.onload=(e)=>{ 
                    const i=new Image(); i.src=e.target.result; 
                    i.onload=()=>{ 
                        const canvas=document.createElement("canvas"); 
                        const maxSize=400; 
                        let w=i.width; let h=i.height;
                        if(w>h){ if(w>maxSize){h*=maxSize/w; w=maxSize;} } else { if(h>maxSize){w*=maxSize/h; h=maxSize;} }
                        canvas.width=w; canvas.height=h; 
                        canvas.getContext("2d").drawImage(i,0,0,w,h);
                        newProfileImg=canvas.toDataURL("image/jpeg",0.9); 
                        document.getElementById('profilePreview').src=newProfileImg; 
                    }
                }
            }
        };

        window.addNewLink = () => {
            if(!sidebarData.links) sidebarData.links = [];
            sidebarData.links.push({ name: "", url: "", icon: "fab fa-whatsapp" });
            renderSidebarEdit();
        };

        window.removeLink = (index) => {
            sidebarData.links.splice(index, 1);
            renderSidebarEdit();
        };

        window.saveSidebarSettings = () => {
            const saveBtn = document.getElementById('saveSidebarBtn');
            const originalText = saveBtn.innerText;
            
            saveBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
            saveBtn.style.opacity = "0.7";

            // Ø¬Ù„Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø§ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const bio = document.getElementById('profileBioInput').value;

            const linkItems = document.querySelectorAll('.link-item');
            const newLinks = [];
            
            linkItems.forEach(item => {
                newLinks.push({
                    icon: item.querySelector('.link-icon-input').value, 
                    name: item.querySelector('.link-name').value,
                    url: item.querySelector('.link-url').value
                });
            });

            const finalData = {
                profileImg: newProfileImg,
                bio: bio, // Ø­ÙØ¸ Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                links: newLinks
            };

            set(ref(db, 'settings'), finalData)
                .then(() => {
                    saveBtn.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…";
                    saveBtn.style.background = "#10b981";
                    saveBtn.style.opacity = "1";
                    setTimeout(() => {
                        saveBtn.innerText = originalText;
                        saveBtn.style.background = "#3b82f6";
                    }, 2000);
                })
                .catch(e => {
                    saveBtn.innerText = "Ø®Ø·Ø£!";
                    saveBtn.style.background = "#ef4444";
                    showAlert("Ø®Ø·Ø£", e.message, "âŒ");
                });
        };

        window.bulkDelete = () => {
            if(selectedApps.size === 0) return showAlert("ØªÙ†Ø¨ÙŠÙ‡", "Ø­Ø¯Ø¯ Ø¹Ù†Ø§ØµØ± Ø£ÙˆÙ„Ø§Ù‹!", "âš ï¸");
            const updates = {}; selectedApps.forEach(key => updates[`apps/${key}`] = null);
            update(ref(db), updates); window.toggleSelectMode();
        };
        window.bulkHide = () => {
            if(selectedApps.size === 0) return showAlert("ØªÙ†Ø¨ÙŠÙ‡", "Ø­Ø¯Ø¯ Ø¹Ù†Ø§ØµØ± Ø£ÙˆÙ„Ø§Ù‹!", "âš ï¸");
            const updates = {}; selectedApps.forEach(key => updates[`apps/${key}/isHidden`] = !allApps[key].isHidden);
            update(ref(db), updates); window.toggleSelectMode();
        };
        window.bulkMove = () => {
            if(selectedApps.size === 0) return showAlert("ØªÙ†Ø¨ÙŠÙ‡", "Ø­Ø¯Ø¯ Ø¹Ù†Ø§ØµØ± Ø£ÙˆÙ„Ø§Ù‹!", "âš ï¸");
            const select = document.getElementById('moveTargetCat'); select.innerHTML = '';
            Object.entries(allCats).forEach(([k, v]) => select.innerHTML += `<option value="${k}">${v.name}</option>`);
            document.getElementById('moveModal').style.display = 'flex';
        };
        window.confirmBulkMove = () => {
            const target = document.getElementById('moveTargetCat').value;
            const updates = {}; selectedApps.forEach(key => updates[`apps/${key}/type`] = target);
            update(ref(db), updates); closeModal('moveModal'); window.toggleSelectMode();
            showAlert("ØªÙ… Ø§Ù„Ù†Ù‚Ù„", "ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "ğŸšš");
        };
        window.openEditModal = (key, data) => {
            const modal = document.getElementById('appModal'); modal.style.display = 'flex';
            if(key) { editKey = key; currentImg = data.img; document.getElementById('appCat').value = data.type; document.getElementById('appName').value = data.name; document.getElementById('appLink').value = data.link; document.getElementById('appHidden').checked = data.isHidden; document.getElementById('previewImg').src = data.img; document.getElementById('previewImg').style.display='block'; document.getElementById('delBtn').style.display='block'; document.getElementById('saveBtn').innerText='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª'; }
            else { editKey = null; currentImg=""; document.getElementById('appName').value=""; document.getElementById('appLink').value=""; document.getElementById('previewImg').style.display='none'; document.getElementById('delBtn').style.display='none'; document.getElementById('saveBtn').innerText='Ù†Ø´Ø±'; }
        };
        window.saveApp = () => {
            const name = document.getElementById('appName').value; const link = document.getElementById('appLink').value; const type = document.getElementById('appCat').value; const isHidden = document.getElementById('appHidden').checked;
            if(!name) return showAlert("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø·Ù„ÙˆØ¨", "âŒ");
            const data = { name, link, type, isHidden, img: currentImg || "https://cdn-icons-png.flaticon.com/512/564/564619.png", order: editKey ? allApps[editKey].order : 0 };
            if(editKey) update(ref(db, 'apps/'+editKey), data); else push(ref(db, 'apps'), data);
            closeModal('appModal');
        };
        window.deleteSingleApp = () => { remove(ref(db, 'apps/'+editKey)); closeModal('appModal'); };
        
        window.processImage = () => { 
            const f=document.getElementById('fileInput').files[0]; 
            if(f){ 
                const r=new FileReader(); 
                r.readAsDataURL(f); 
                r.onload=(e)=>{ 
                    const i=new Image(); 
                    i.src=e.target.result; 
                    i.onload=()=>{ 
                        const canvas=document.createElement("canvas"); 
                        const maxWidth = 1080;
                        let width = i.width;
                        let height = i.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext("2d").drawImage(i,0,0,width,height);
                        currentImg=canvas.toDataURL("image/jpeg",0.95); 
                        document.getElementById('previewImg').src=currentImg; 
                        document.getElementById('previewImg').style.display='block'; 
                    }
                }
            }
        };
        window.openCatModal = () => document.getElementById('catModal').style.display='flex';
        window.closeModal = (id) => document.getElementById(id).style.display='none';
    </script>
</body>
</html>
