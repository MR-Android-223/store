<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin V53 | Link Mode</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-body: #0f172a; --bg-gradient: radial-gradient(circle at 50% 0%, #1e293b, #0f172a);
            --card-glass: rgba(30, 41, 59, 0.98); --text-main: #f8fafc; --text-muted: #94a3b8;
            --primary: #3b82f6; --danger: #ef4444; --border: rgba(255,255,255,0.08);
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-body); background-image: var(--bg-gradient); 
            color: var(--text-main); font-family: 'Cairo', sans-serif; 
            min-height: 100vh; padding-bottom: 100px; 
            overflow-y: auto; touch-action: pan-y; 
        }

        button:active, .header-btn:active, .fab-btn:active, .cat-action:active { transform: scale(0.94); transition: 0.1s; }

        header {
            position: sticky; top: 0; z-index: 1000; background: rgba(15, 23, 42, 0.98);
            border-bottom: 1px solid var(--border); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-btn {
            background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 12px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .header-btn.active { background: var(--primary); border-color: var(--primary); }

        .tabs-wrapper { position: sticky; top: 68px; z-index: 900; padding: 10px 0; background: #0f172a; }
        .tabs-container { display: flex; gap: 8px; overflow-x: auto; padding: 0 20px; scrollbar-width: none; }
        .tab-btn {
            background: var(--card-glass); color: var(--text-muted); border: 1px solid var(--border);
            padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: 0.3s;
            font-family: 'Cairo'; font-weight: 700; font-size: 0.85rem; white-space: nowrap; flex-shrink: 0;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 10px 20px; max-width: 1000px; margin: 0 auto; }
        .card {
            background: var(--card-glass); border-radius: 18px; padding: 15px; border: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; position: relative; transition: transform 0.1s;
        }
        
        .sortable-ghost { opacity: 0.4; background: var(--primary); }
        .sortable-drag { cursor: grabbing; opacity: 1; background: #1e293b; transform: scale(1.05); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        .card.selected { border: 2px solid var(--primary); background: rgba(59, 130, 246, 0.15); }
        .check-circle { 
            position: absolute; top: 10px; left: 10px; width: 22px; height: 22px; 
            border-radius: 50%; border: 2px solid #94a3b8; background: transparent; transition: 0.2s;
            display: none;
        }
        .card.select-mode .check-circle { display: block; }
        .card.selected .check-circle { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .card.selected .check-circle::after { content: 'âœ“'; color: white; font-size: 0.8rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .card img { width: 60px; height: 60px; border-radius: 14px; margin-bottom: 10px; object-fit: cover; pointer-events: none; }
        .card-title { font-size: 0.9rem; font-weight: 700; text-align: center; margin-bottom: 5px; height: 40px; overflow: hidden; pointer-events: none; }
        .edit-badge { position: absolute; top: 10px; left: 10px; background: #f59e0b; color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; }
        
        .drag-handle { 
            position: absolute; top: 0; right: 0; color: #94a3b8; cursor: grab; 
            padding: 15px; width: 50px; height: 50px; z-index: 10; font-size: 1.4rem; 
            display: flex; align-items: center; justify-content: center;
            touch-action: none; 
        }
        .card.select-mode .drag-handle { display: none; }
        .card.select-mode .edit-badge { display: none; }

        .fab-btn {
            position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px;
            background: var(--primary); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            cursor: pointer; z-index: 2000; border: none; transition: 0.3s;
        }

        #bulkBar {
            position: fixed; bottom: -120px; left: 0; width: 100%; 
            background: #1e293b; border-top: 1px solid var(--primary);
            padding: 15px 20px; z-index: 2500; display: flex; gap: 10px; 
            transition: 0.3s; box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
        }
        #bulkBar.visible { bottom: 0; }
        .bulk-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.8rem; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-box { background: #1e293b; padding: 25px; border-radius: 20px; width: 90%; max-width: 380px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; max-height: 85vh; overflow-y: auto;}
        .modal-title { font-size: 1.2rem; color: white; margin-bottom: 20px; font-weight: bold; }
        
        .btn-full { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; font-family: 'Cairo'; margin-bottom: 8px; transition: 0.1s;}
        .btn-confirm { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-cancel { background: transparent; color: #94a3b8; border: 1px solid #334155; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: none; outline: none; font-size: 1rem; background: #334155; color: white; font-family: 'Cairo'; text-align: center; }
        
        /* Ø¬Ø¹Ù„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† */
        input.url-input { direction: ltr; text-align: left; }

        .cat-item, .link-item { display: flex; gap: 8px; align-items: center; background: #334155; padding: 10px; margin-bottom: 8px; border-radius: 10px; border: 1px solid transparent;}
        
        .cat-drag { cursor: grab; font-size: 1.2rem; color: #94a3b8; padding: 5px; touch-action: none; }
        
        .cat-icon-input { width: 45px; margin: 0; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px; font-size: 1.2rem; }
        .cat-name-input { flex-grow: 1; margin: 0; background: transparent; text-align: right; padding: 8px; }
        .cat-action { padding: 8px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; color: white; }
        
        .toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            background: #0f172a; padding: 12px; margin-bottom: 8px; border-radius: 12px; border: 1px solid #334155;
        }
        .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .settings-menu-btn {
            display: flex; align-items: center; justify-content: space-between;
            background: #334155; color: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.05); font-weight: 600;
        }
        .settings-section { display: none; text-align: right; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        .search-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: #334155; margin-bottom: 8px; border-radius: 12px; cursor: pointer; text-align: right;
        }
        .icon-select {
            background: #1e293b; color: white; border: 1px solid #475569;
            padding: 5px; border-radius: 8px; font-size: 0.8rem; width: 100%;
        }

    </style>
</head>
<body>

    <header>
        <div style="font-weight:900; font-size:1.2rem;">Admin<span style="color:#3b82f6">Panel</span></div>
        <div style="display:flex; gap:8px;">
            <button onclick="openSettingsModal()" class="header-btn">
                <i class="fas fa-cog"></i> 
            </button>
            <button onclick="toggleSelectMode()" id="selectBtn" class="header-btn">
                <i class="fas fa-check-square"></i> ØªØ­Ø¯ÙŠØ¯
            </button>
            <button onclick="openCatModal()" class="header-btn">
                <i class="fas fa-folder"></i>
            </button>
            <button onclick="login()" id="loginBtn" class="header-btn" style="background:#ea4335; border-color:#ea4335;">Login</button>
        </div>
    </header>

    <div class="tabs-wrapper">
        <div class="tabs-container" id="tabsList"></div>
    </div>

    <div class="grid" id="appsContainer">
        <div style="grid-column: span 2; text-align: center; color: #94a3b8; margin-top: 50px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <button class="fab-btn" id="addBtn" onclick="openAddChoiceModal()">+</button>

    <div id="bulkBar">
        <button class="bulk-btn" onclick="bulkMove()" style="background: #3b82f6;">
            <i class="fas fa-exchange-alt"></i> Ù†Ù‚Ù„
        </button>
        <button class="bulk-btn" onclick="bulkHide()" style="background: #f59e0b;">
            <i class="fas fa-eye-slash"></i> Ø­Ø§Ù„Ø©
        </button>
        <button class="bulk-btn" onclick="bulkDelete()" style="background: #ef4444;">
            <i class="fas fa-trash"></i> Ø­Ø°Ù
        </button>
    </div>

    <div id="addChoiceModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</div>
            <button onclick="openSearchModal()" class="btn-full" style="background: #10b981;">
                <i class="fab fa-google-play"></i> Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±
            </button>
            <button onclick="openEditModal()" class="btn-full" style="background: #3b82f6;">
                <i class="fas fa-pen"></i> Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©
            </button>
            <button onclick="closeModal('addChoiceModal')" class="btn-full btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="searchModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¬Ø±</div>
            <div style="position:relative; margin-bottom:10px;">
                <input type="text" id="storeSearchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..." style="padding-right:40px;">
                <i class="fas fa-search" onclick="doStoreSearch()" style="position:absolute; right:12px; top:12px; color:var(--primary); cursor:pointer;"></i>
            </div>
            <div id="searchResults" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
            <button onclick="closeModal('searchModal')" class="btn-full btn-cancel">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 450px;">
            <div class="modal-title" style="margin-bottom:20px;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            
            <div id="settingsMain">
                <div class="settings-menu-btn" onclick="openSettingsSection('catLock')">
                    <span><i class="fas fa-lock" style="margin-left:10px; color:#f59e0b;"></i> Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                    <i class="fas fa-chevron-left"></i>
                </div>
                <div class="settings-menu-btn" onclick="openSettingsSection('manageCats')">
                    <span><i class="fas fa-folder" style="margin-left:10px; color:#3b82f6;"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                    <i class="fas fa-chevron-left"></i>
                </div>
                <div class="settings-menu-btn" onclick="openSettingsSection('sidebarEdit')">
                    <span><i class="fas fa-user-edit" style="margin-left:10px; color:#10b981;"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
                    <i class="fas fa-chevron-left"></i>
                </div>
                <button onclick="closeModal('settingsModal')" class="btn-full btn-cancel" style="margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>

            <div id="catLockSection" class="settings-section">
                <div style="margin-bottom:15px; color:#94a3b8; font-size:0.85rem;">Ø§Ø¶ØºØ· Ù„Ù„Ù‚ÙÙ„/Ø§Ù„ÙØªØ­:</div>
                <div id="catLockList" style="max-height:300px; overflow-y:auto;"></div>
                <button onclick="backToSettingsMain()" class="btn-full btn-cancel" style="margin-top:15px;">Ø±Ø¬ÙˆØ¹</button>
            </div>

            <div id="manageCatsSection" class="settings-section">
                 <div style="margin-bottom:10px; color:#94a3b8; font-size:0.8rem;">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ±ØªÙŠØ¨ | Ø§Ø¶ØºØ· Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­ÙØ¸ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</div>
                <div id="catManageList" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
                
                <div style="border-top:1px solid #334155; padding-top:10px;">
                    <input type="text" id="newCatIcon" placeholder="Ø±Ù…Ø²" style="width:20%; display:inline-block;">
                    <input type="text" id="newCatName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…" style="width:75%; display:inline-block;">
                    <button onclick="addCategory()" class="btn-full btn-confirm" style="margin-top:5px;">+ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
                </div>
                <button onclick="backToSettingsMain()" class="btn-full btn-cancel" style="margin-top:10px;">Ø±Ø¬ÙˆØ¹</button>
            </div>

            <div id="sidebarEditSection" class="settings-section">
                <div style="border-bottom:1px solid #334155; padding-bottom:15px; margin-bottom:15px;">
                    <img id="profilePreview" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid #3b82f6; object-fit:cover; margin-bottom:10px;">
                    
                    <label style="color:#94a3b8; font-size:0.8rem; display:block; text-align:right;">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©:</label>
                    <input type="text" id="profileImgUrl" class="url-input" placeholder="https://..." oninput="document.getElementById('profilePreview').src=this.value">
                    
                    <div style="margin-top:10px; text-align:right;">
                        <label style="color:#94a3b8; font-size:0.8rem;">Ø§Ù„Ø¨Ø§ÙŠÙˆ:</label>
                        <input type="text" id="profileBioInput" placeholder="Ø§Ù„ÙˆØµÙ..." style="width:100%; margin-top:5px; background:#0f172a;">
                    </div>
                </div>
                
                <div id="linksList" style="max-height:200px; overflow-y:auto; margin-bottom:10px;"></div>
                
                <button onclick="addNewLink()" class="btn-full" style="background:#334155; border:1px dashed #94a3b8; margin-bottom:10px;">+ Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</button>
                <button onclick="saveSidebarSettings()" id="saveSidebarBtn" class="btn-full btn-confirm">Ø­ÙØ¸</button>
                <button onclick="backToSettingsMain()" class="btn-full btn-cancel">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>
    </div>

    <div id="appModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
            <select id="appCat"></select>
            <input type="text" id="appName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="appLink" class="url-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚/Ø§Ù„Ù…ÙˆÙ‚Ø¹">
            
            <input type="text" id="appImgUrl" class="url-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Image URL)" oninput="updatePreview(this.value)">
            
            <img id="previewImg" style="width:80px; height:80px; object-fit:cover; display:none; margin:10px auto; border-radius:12px;">
            
            <div style="display:flex; justify-content:space-between; margin:15px 0; background:#0f172a; padding:10px; border-radius:10px;">
                <span>Ø¥Ø®ÙØ§Ø¡ØŸ</span>
                <input type="checkbox" id="appHidden" style="width:20px;">
            </div>
            <button onclick="saveApp()" id="saveBtn" class="btn-full btn-confirm">Ø­ÙØ¸</button>
            <button onclick="deleteSingleApp()" id="delBtn" class="btn-full btn-danger" style="display:none;">Ø­Ø°Ù</button>
            <button onclick="closeModal('appModal')" class="btn-full btn-cancel">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay" style="z-index: 5000;">
        <div class="modal-box">
            <div id="alertIcon" style="font-size:3rem; margin-bottom:10px;"></div>
            <div id="alertTitle" class="modal-title"></div>
            <div id="alertMsg" style="color:#94a3b8; margin-bottom:20px;"></div>
            <button onclick="closeModal('alertModal')" class="btn-full btn-confirm">Ø­Ø³Ù†Ø§Ù‹</button>
        </div>
    </div>

    <div id="moveModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Ù†Ù‚Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</div>
            <select id="moveTargetCat"></select>
            <button onclick="confirmBulkMove()" class="btn-full btn-confirm">Ù†Ù‚Ù„</button>
            <button onclick="closeModal('moveModal')" class="btn-full btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, update, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC_iEb4UhUREVJ2mfj00BounPVaeGQr7wI",
            authDomain: "mohammadalboushi-e9231.firebaseapp.com",
            projectId: "mohammadalboushi-e9231",
            databaseURL: "https://mohammadalboushi-e9231-default-rtdb.firebaseio.com/",
            appId: "1:236925802081:web:2e26094ab5ecdf988f3c20"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        const myUID = "eBOYmcmDI5S6l4NQd36bEa5kEcZ2";

        let allApps = {};
        let allCats = {};
        let currentFilter = 'ALL';
        let isSelectMode = false;
        let selectedApps = new Set();
        let editKey = null;
        
        let appSortable = null;
        let catSortable = null;
        let linkSortable = null;
        let sidebarData = { profileImg: "", bio: "", links: [] };

        const ICON_OPTIONS = [
            {val: "fab fa-whatsapp", label: "ÙˆØ§ØªØ³Ø§Ø¨"},
            {val: "fab fa-facebook", label: "ÙÙŠØ³Ø¨ÙˆÙƒ"},
            {val: "fab fa-instagram", label: "Ø§Ù†Ø³ØªØºØ±Ø§Ù…"},
            {val: "fab fa-tiktok", label: "ØªÙŠÙƒ ØªÙˆÙƒ"},
            {val: "fab fa-youtube", label: "ÙŠÙˆØªÙŠÙˆØ¨"},
            {val: "fab fa-telegram", label: "ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…"},
            {val: "fab fa-twitter", label: "ØªÙˆÙŠØªØ±"},
            {val: "fas fa-globe", label: "Ù…ÙˆÙ‚Ø¹ ÙˆÙŠØ¨"},
            {val: "fas fa-phone", label: "Ø§ØªØµØ§Ù„"},
            {val: "fas fa-envelope", label: "Ø§ÙŠÙ…ÙŠÙ„"},
            {val: "fas fa-map-marker-alt", label: "Ù…ÙˆÙ‚Ø¹"},
            {val: "fas fa-link", label: "Ø±Ø§Ø¨Ø· Ø¹Ø§Ù…"}
        ];

        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === myUID) {
                document.getElementById('loginBtn').style.display = 'none';
                initData();
            } else {
                document.getElementById('loginBtn').style.display = 'flex';
                document.getElementById('appsContainer').innerHTML = "<div style='grid-column:span 2; text-align:center;'>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>";
            }
        });
        window.login = () => signInWithPopup(auth, provider);

        function initData() {
            onValue(ref(db, 'categories'), (s) => {
                const val = s.val();
                if(!val) update(ref(db, 'categories'), {'DEF': {name: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª', icon:'ğŸ“±', order: 1}});
                else { 
                    allCats = val; 
                    renderTabs(); 
                    if(document.getElementById('catLockSection').style.display==='block') renderCatLockList();
                    if(document.getElementById('manageCatsSection').style.display==='block') renderCatManageList();
                }
            });

            onValue(ref(db, 'apps'), (s) => {
                allApps = s.val() || {};
                renderApps();
            });

            onValue(ref(db, 'settings'), (s) => {
                sidebarData = s.val() || {links:[]};
                if(document.getElementById('sidebarEditSection').style.display==='block') renderSidebarEdit();
            });
        }

        window.renderTabs = () => {
            const list = document.getElementById('tabsList');
            const sorted = Object.entries(allCats).sort(([,a],[,b]) => (a.order||0)-(b.order||0));
            
            let html = `<button class="tab-btn ${currentFilter==='ALL'?'active':''}" onclick="setFilter('ALL')">Ø§Ù„ÙƒÙ„</button>`;
            let opts = '';
            
            sorted.forEach(([k, v]) => {
                const isHidden = (v.isHidden === true || v.isHidden === "true");
                const hiddenIcon = isHidden ? 'ğŸ”’ ' : '';
                html += `<button class="tab-btn ${currentFilter===k?'active':''}" onclick="setFilter('${k}')">${hiddenIcon}${v.icon||''} ${v.name}</button>`;
                opts += `<option value="${k}">${v.name}</option>`;
            });
            list.innerHTML = html;
            document.getElementById('appCat').innerHTML = opts;
            document.getElementById('moveTargetCat').innerHTML = opts;
        };

        window.setFilter = (f) => { currentFilter = f; renderApps(); };

        function renderApps() {
            const container = document.getElementById('appsContainer');
            if(appSortable) { appSortable.destroy(); appSortable = null; }
            
            let items = Object.entries(allApps);
            if(currentFilter !== 'ALL') items = items.filter(([,v]) => v.type === currentFilter);
            items.sort(([,a],[,b]) => (a.order||0) - (b.order||0));

            container.innerHTML = '';
            items.forEach(([k, v]) => {
                const isSelected = selectedApps.has(k) ? 'selected' : '';
                const hiddenStyle = v.isHidden ? 'opacity:0.5; filter:grayscale(1);' : '';
                
                const card = document.createElement('div');
                card.className = `card ${isSelected} ${isSelectMode ? 'select-mode' : ''}`;
                card.style.cssText = hiddenStyle;
                card.setAttribute('data-key', k);
                
                card.onclick = (e) => {
                    if(e.target.closest('.drag-handle')) return;
                    if(isSelectMode) toggleSelection(k);
                    else openEditModal(k, v);
                };

                card.innerHTML = `
                    <div class="check-circle"></div>
                    <div class="edit-badge"><i class="fas fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„</div>
                    ${!isSelectMode && currentFilter === 'ALL' ? '<div class="drag-handle"><i class="fas fa-bars"></i></div>' : ''}
                    <img src="${v.img}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/564/564619.png'">
                    <div class="card-title">${v.name}</div>
                `;
                container.appendChild(card);
            });

            if(currentFilter === 'ALL' && !isSelectMode) {
                appSortable = new Sortable(container, {
                    handle: '.drag-handle', animation: 150,
                    onEnd: () => {
                        const updates = {};
                        [...container.children].forEach((el, idx) => {
                            updates[`apps/${el.getAttribute('data-key')}/order`] = idx;
                        });
                        update(ref(db), updates);
                    }
                });
            }
        }

        // ============ CATEGORIES & SETTINGS ============
        function renderCatLockList() {
            const list = document.getElementById('catLockList');
            list.innerHTML = '';
            Object.entries(allCats).sort(([,a],[,b]) => (a.order||0)-(b.order||0)).forEach(([k, v]) => {
                const isHidden = (v.isHidden === true || v.isHidden === "true");
                const isChecked = isHidden ? '' : 'checked'; 
                const statusText = isHidden ? '<span style="color:#94a3b8">(Ù…Ø®ÙÙŠ)</span>' : '<span style="color:#10b981">(Ø¸Ø§Ù‡Ø±)</span>';

                const div = document.createElement('div');
                div.className = 'toggle-row';
                div.innerHTML = `
                    <div style="font-weight:bold;">${v.icon||''} ${v.name} ${statusText}</div>
                    <label class="switch">
                        <input type="checkbox" ${isChecked} onchange="toggleCat('${k}', this.checked)">
                        <span class="slider"></span>
                    </label>
                `;
                list.appendChild(div);
            });
        }
        
        window.toggleCat = (key, isChecked) => {
            set(ref(db, `categories/${key}/isHidden`), !isChecked);
        };
        
        function renderCatManageList() {
            const list = document.getElementById('catManageList');
            list.innerHTML = '';
            if(catSortable) { catSortable.destroy(); catSortable = null; }
            
            const sorted = Object.entries(allCats).sort(([,a],[,b]) => (a.order||0)-(b.order||0));
            sorted.forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = 'cat-item';
                div.setAttribute('data-key', k);
                div.innerHTML = `
                    <div class="cat-drag"><i class="fas fa-bars"></i></div>
                    <input type="text" class="cat-icon-input" id="icon-${k}" value="${v.icon||''}">
                    <input type="text" class="cat-name-input" id="name-${k}" value="${v.name}">
                    <i class="fas fa-save cat-action" style="color:#3b82f6" onclick="saveCat('${k}')"></i>
                    <i class="fas fa-trash cat-action" style="color:#ef4444" onclick="deleteCat('${k}')"></i>
                `;
                list.appendChild(div);
            });
            
            catSortable = new Sortable(list, {
                handle: '.cat-drag', animation: 150,
                onEnd: () => {
                    const updates = {};
                    [...list.children].forEach((el, idx) => {
                        updates[`categories/${el.getAttribute('data-key')}/order`] = idx;
                    });
                    update(ref(db), updates);
                }
            });
        }
        
        window.saveCat = (key) => {
            const n = document.getElementById(`name-${key}`).value;
            const i = document.getElementById(`icon-${key}`).value;
            update(ref(db, `categories/${key}`), {name: n, icon: i})
            .then(() => showAlert("ØªÙ…", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø³Ù…", "âœ…"));
        };
        
        window.addNewCategory = () => {
            const n = document.getElementById('newCatName').value;
            const i = document.getElementById('newCatIcon').value;
            if(n) update(ref(db, `categories/CAT_${Date.now()}`), {name: n, icon: i||'ğŸ“', order: 99});
        };
        
        window.deleteCat = (k) => {
            if(confirm("Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ")) remove(ref(db, `categories/${k}`));
        };

        // ============ SIDEBAR EDIT (UPDATED for URL) ============
        function renderSidebarEdit() {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
            const profileUrl = sidebarData.profileImg || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            document.getElementById('profilePreview').src = profileUrl;
            document.getElementById('profileImgUrl').value = sidebarData.profileImg || ""; // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„
            
            document.getElementById('profileBioInput').value = sidebarData.bio || "";
            
            const list = document.getElementById('linksList');
            list.innerHTML = '';
            if(linkSortable) { linkSortable.destroy(); linkSortable = null; }
            
            const links = sidebarData.links || [];
            links.forEach((link, idx) => {
                const div = document.createElement('div');
                div.className = 'link-item';
                
                let opts = '';
                ICON_OPTIONS.forEach(opt => {
                    opts += `<option value="${opt.val}" ${link.icon === opt.val ? 'selected' : ''}>${opt.label}</option>`;
                });
                
                div.innerHTML = `
                    <div class="cat-drag"><i class="fas fa-bars"></i></div>
                    <div style="flex-grow:1;">
                        <select class="icon-select" onchange="this.parentElement.dataset.icon=this.value">${opts}</select>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <input type="text" class="link-name" value="${link.name}" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin:0; padding:5px; font-size:0.8rem;">
                            <input type="text" class="link-url url-input" value="${link.url}" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·" style="margin:0; padding:5px; font-size:0.8rem;">
                        </div>
                    </div>
                    <i class="fas fa-trash cat-action" style="color:#ef4444" onclick="removeLink(${idx})"></i>
                `;
                div.querySelector('.icon-select').parentElement.dataset.icon = link.icon;
                list.appendChild(div);
            });
            
            linkSortable = new Sortable(list, { handle: '.cat-drag', animation: 150 });
        }
        
        window.saveSidebarSettings = () => {
            const bio = document.getElementById('profileBioInput').value;
            // Ø£Ø®Ø° Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø­Ù‚Ù„
            const pImg = document.getElementById('profileImgUrl').value;
            
            const links = [];
            document.querySelectorAll('.link-item').forEach(item => {
                const iconVal = item.querySelector('div[style="flex-grow:1;"]').dataset.icon || item.querySelector('.icon-select').value;
                links.push({
                    icon: iconVal,
                    name: item.querySelector('.link-name').value,
                    url: item.querySelector('.link-url').value
                });
            });
            set(ref(db, 'settings'), { profileImg: pImg, bio: bio, links: links })
            .then(() => showAlert("ØªÙ…", "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", "âœ…"));
        };
        
        window.addNewLink = () => {
            if(!sidebarData.links) sidebarData.links = [];
            sidebarData.links.push({name: '', url: '', icon: 'fab fa-whatsapp'});
            renderSidebarEdit();
        };
        
        window.removeLink = (i) => {
            sidebarData.links.splice(i, 1);
            renderSidebarEdit();
        };

        // ============ SEARCH (Fixed Proxy Version) ============
        window.doStoreSearch = async () => {
            const q = document.getElementById('storeSearchInput').value;
            const res = document.getElementById('searchResults');
            if(!q) return;
            
            res.innerHTML = '<div style="text-align:center; padding:20px; color:#3b82f6;"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';
            
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ø­Ø¸Ø±
                const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://itunes.apple.com/search?term='+q+'&entity=software&limit=6&country=SA')}`;
                
                const response = await fetch(url);
                const dataWrapper = await response.json();
                const data = JSON.parse(dataWrapper.contents);

                res.innerHTML = '';
                if(data.results.length === 0) { res.innerHTML = '<div style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return; }

                data.results.forEach(app => {
                    const safeLink = `market://search?q=${encodeURIComponent(app.trackName)}&c=apps`;
                    const imgUrl = app.artworkUrl100.replace('100x100', '512x512');
                    
                    const item = document.createElement('div');
                    item.className = 'search-item';
                    item.onclick = () => {
                        closeModal('searchModal'); openEditModal(null);
                        document.getElementById('appName').value = app.trackName;
                        
                        // Ù‡Ù†Ø§ Ù†Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
                        document.getElementById('appImgUrl').value = imgUrl; 
                        window.updatePreview(imgUrl);
                        
                        document.getElementById('appLink').value = safeLink;
                    };
                    item.innerHTML = `
                        <img src="${imgUrl}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                        <div style="flex-grow:1;">
                            <div style="font-weight:bold; font-size:0.9rem;">${app.trackName}</div>
                            <div style="font-size:0.7rem; color:#94a3b8;">${app.artistName}</div>
                        </div>
                        <i class="fas fa-plus-circle" style="color:#10b981; font-size:1.2rem;"></i>
                    `;
                    res.appendChild(item);
                });
            } catch(e) { 
                console.error(e);
                res.innerHTML = '<div style="text-align:center; color:#ef4444;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†Øª)</div>'; 
            }
        };               
        
        // ============ HELPERS ============
        window.toggleSelectMode = () => {
            isSelectMode = !isSelectMode; selectedApps.clear();
            const btn = document.getElementById('selectBtn');
            const bulkBar = document.getElementById('bulkBar');
            const addBtn = document.getElementById('addBtn');
            if(isSelectMode) { btn.classList.add('active'); bulkBar.classList.add('visible'); addBtn.style.display='none'; }
            else { btn.classList.remove('active'); bulkBar.classList.remove('visible'); addBtn.style.display='flex'; }
            renderApps();
        };

        window.toggleSelection = (k) => {
            if(selectedApps.has(k)) selectedApps.delete(k); else selectedApps.add(k);
            renderApps();
        };

        window.bulkDelete = () => {
            if(selectedApps.size===0) return showAlert("ØªÙ†Ø¨ÙŠÙ‡","Ø­Ø¯Ø¯ Ø¹Ù†Ø§ØµØ±");
            if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ØŸ")) {
                const u={}; selectedApps.forEach(k=>u[`apps/${k}`]=null);
                update(ref(db),u); toggleSelectMode();
            }
        };

        window.bulkHide = () => {
            if(selectedApps.size===0) return showAlert("ØªÙ†Ø¨ÙŠÙ‡","Ø­Ø¯Ø¯ Ø¹Ù†Ø§ØµØ±");
            const u={}; selectedApps.forEach(k=>u[`apps/${k}/isHidden`]=!allApps[k].isHidden);
            update(ref(db),u); toggleSelectMode();
        };

        window.bulkMove = () => {
            if(selectedApps.size===0) return showAlert("ØªÙ†Ø¨ÙŠÙ‡","Ø­Ø¯Ø¯ Ø¹Ù†Ø§ØµØ±");
            document.getElementById('moveModal').style.display='flex';
        };

        window.confirmBulkMove = () => {
            const t=document.getElementById('moveTargetCat').value;
            const u={}; selectedApps.forEach(k=>u[`apps/${k}/type`]=t);
            update(ref(db),u); closeModal('moveModal'); toggleSelectMode();
        };

        // [NEW] Helper to show preview from URL
        window.updatePreview = (url) => {
            const img = document.getElementById('previewImg');
            if(url) {
                img.src = url;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
        };

        window.openEditModal = (key, data) => {
            closeModal('addChoiceModal'); document.getElementById('appModal').style.display = 'flex';
            if(key) {
                editKey = key;
                document.getElementById('appName').value = data.name;
                document.getElementById('appLink').value = data.link;
                document.getElementById('appCat').value = data.type;
                document.getElementById('appHidden').checked = data.isHidden || false;
                
                // ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·
                document.getElementById('appImgUrl').value = data.img || "";
                updatePreview(data.img);

                document.getElementById('saveBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
                document.getElementById('delBtn').style.display = 'block';
            } else {
                editKey = null;
                document.getElementById('appName').value = "";
                document.getElementById('appLink').value = "";
                document.getElementById('appImgUrl').value = ""; // ØªÙØ±ÙŠØº
                updatePreview("");
                
                document.getElementById('appHidden').checked = false;
                document.getElementById('saveBtn').innerText = 'Ø¥Ø¶Ø§ÙØ©';
                document.getElementById('delBtn').style.display = 'none';
            }
        };

        window.saveApp = () => {
            const name = document.getElementById('appName').value;
            const imgUrl = document.getElementById('appImgUrl').value;
            
            if(!name) return showAlert("Ø®Ø·Ø£", "Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨", "âŒ");
            
            const d = { 
                name, 
                link: document.getElementById('appLink').value, 
                type: document.getElementById('appCat').value, 
                isHidden: document.getElementById('appHidden').checked,
                img: imgUrl || "https://cdn-icons-png.flaticon.com/512/564/564619.png", // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø·
                order: editKey ? allApps[editKey].order : 9999
            };
            if(editKey) update(ref(db, `apps/${editKey}`), d); else push(ref(db, 'apps'), d);
            closeModal('appModal');
        };

        window.deleteSingleApp = () => { remove(ref(db, 'apps/'+editKey)); closeModal('appModal'); };

        window.openSettingsModal = () => { document.getElementById('settingsModal').style.display='flex'; backToSettingsMain(); };
        window.openSettingsSection = (s) => {
            document.getElementById('settingsMain').style.display='none';
            document.getElementById(s+'Section').style.display='block';
            if(s==='catLock') renderCatLockList();
            if(s==='manageCats') renderCatManageList();
            if(s==='sidebarEdit') renderSidebarEdit();
        };
        window.backToSettingsMain = () => { document.querySelectorAll('.settings-section').forEach(e=>e.style.display='none'); document.getElementById('settingsMain').style.display='block'; };
        
        window.openAddChoiceModal = () => document.getElementById('addChoiceModal').style.display='flex';
        window.openSearchModal = () => { closeModal('addChoiceModal'); document.getElementById('searchModal').style.display='flex'; };
        window.openCatModal = () => { document.getElementById('settingsModal').style.display='flex'; openSettingsSection('manageCats'); }; 
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        window.showAlert = (t, m, i) => { document.getElementById('alertTitle').innerText=t; document.getElementById('alertMsg').innerText=m; document.getElementById('alertIcon').innerText=i; document.getElementById('alertModal').style.display='flex'; };

    </script>
</body>
</html>
