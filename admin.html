<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin V16 | ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); text-align: center; margin: 0; padding: 20px; padding-bottom: 100px; }
        
        .box { background: var(--card); padding: 25px; border-radius: 20px; max-width: 500px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: none; outline: none; font-size: 1rem; box-sizing: border-box; }
        input, select { background: #334155; color: white; }
        
        .upload-area { border: 2px dashed #334155; padding: 15px; border-radius: 12px; margin: 10px 0; cursor: pointer; }
        #previewImg { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; display: none; margin: 10px auto; border: 2px solid var(--primary); }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© (Ø¹Ø§Ø¯Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯) */
        .filter-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin: 15px 0; white-space: nowrap; }
        .filter-btn { background: #334155; color: #94a3b8; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; border: 1px solid transparent; width: auto; display: inline-block; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .app-item { display: flex; align-items: center; background: #334155; padding: 10px; margin-top: 10px; border-radius: 12px; transition: 0.2s; }
        .app-item.hidden-item { opacity: 0.5; border: 1px dashed #94a3b8; }
        
        /* Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ø³Ø­Ø¨ */
        .drag-handle { cursor: grab; padding: 10px; font-size: 1.5rem; color: #94a3b8; touch-action: none; }
        .drag-disabled { opacity: 0.1; cursor: not-allowed; } /* Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„ÙÙ„ØªØ± Ù…ÙØ¹Ù„ */

        .select-check { width: 20px; height: 20px; margin-left: 10px; display: none; }
        .show-checks .select-check { display: block; }
        
        #bulkActionsBar { position: fixed; bottom: -100px; left: 0; width: 100%; background: var(--card); padding: 15px; transition: 0.3s; z-index: 100; display: flex; justify-content: space-around; }
        #bulkActionsBar.visible { bottom: 0; }
        
        #toast { visibility: hidden; min-width: 200px; background: #10b981; color: white; padding: 15px; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); border-radius: 50px; z-index: 3000; }
        #toast.show { visibility: visible; animation: fade 0.5s; }
        @keyframes fade { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
    </style>
</head>
<body>

<div id="toast">âœ… ØªÙ…</div>

<div class="box">
    <div id="loginArea">
        <h2>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
        <button onclick="login()" style="background:#ea4335; color:white;">Ø¯Ø®ÙˆÙ„ Google</button>
    </div>

    <div id="adminArea" style="display:none;">
        <h3>âœ¨ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
        
        <div id="inputForm">
            <select id="inputType">
                <option value="PROGRAM">ğŸ“± ØªØ·Ø¨ÙŠÙ‚</option>
                <option value="GAME">ğŸ® Ù„Ø¹Ø¨Ø©</option>
                <option value="WEBSITE">ğŸŒ Ù…ÙˆÙ‚Ø¹</option>
                <option value="FILE">ğŸ“ Ù…Ù„Ù</option>
            </select>
            <input type="text" id="appName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="appLink" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <span id="uploadLabel">ğŸ“¸ ØµÙˆØ±Ø©</span>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="processImage()">
                <img id="previewImg">
            </div>
            <button id="saveBtn" style="background: linear-gradient(45deg, #2563eb, #3b82f6); color: white;" onclick="handleProcess()">ğŸš€ Ø­ÙØ¸ ÙˆÙ†Ø´Ø±</button>
            <button id="cancelBtn" style="display:none; background:#475569; color:white;" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>

        <hr style="border-color:#334155; margin:20px 0;">

        <div class="filter-container">
            <div class="filter-btn active" onclick="setFilter('ALL', this)">Ø§Ù„ÙƒÙ„</div>
            <div class="filter-btn" onclick="setFilter('PROGRAM', this)">ØªØ·Ø¨ÙŠÙ‚Ø§Øª</div>
            <div class="filter-btn" onclick="setFilter('GAME', this)">Ø£Ù„Ø¹Ø§Ø¨</div>
            <div class="filter-btn" onclick="setFilter('WEBSITE', this)">Ù…ÙˆØ§Ù‚Ø¹</div>
            <div class="filter-btn" onclick="setFilter('FILE', this)">Ù…Ù„ÙØ§Øª</div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span id="dragHint" style="font-size:0.8rem; color:#f59e0b;">ğŸ’¡ Ø§Ø³Ø­Ø¨ â˜° Ù„Ù„ØªØ±ØªÙŠØ¨ (ÙÙŠ Ù‚Ø³Ù… Ø§Ù„ÙƒÙ„ ÙÙ‚Ø·)</span>
            <button onclick="toggleSelectionMode()" style="width:auto; padding:5px 15px; font-size:0.8rem;">âœ… ØªØ­Ø¯ÙŠØ¯</button>
        </div>

        <div id="appsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
</div>

<div id="bulkActionsBar">
    <button onclick="bulkDelete()" style="background:#ef4444; color:white; border:none; padding:10px; border-radius:10px;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
    <button onclick="bulkToggleVisibility()" style="background:#f59e0b; color:white; border:none; padding:10px; border-radius:10px;">ğŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±</button>
    <button onclick="toggleSelectionMode()" style="background:#475569; color:white; border:none; padding:10px; border-radius:10px;">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_iEb4UhUREVJ2mfj00BounPVaeGQr7wI",
        authDomain: "mohammadalboushi-e9231.firebaseapp.com",
        projectId: "mohammadalboushi-e9231",
        databaseURL: "https://mohammadalboushi-e9231-default-rtdb.firebaseio.com/",
        appId: "1:236925802081:web:2e26094ab5ecdf988f3c20"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();
    const myUID = "eBOYmcmDI5S6l4NQd36bEa5kEcZ2";

    let editKey = null;
    let currentImgBase64 = "";
    let allDataCache = {};
    let isSelectMode = false;
    let selectedItems = new Set();
    let currentFilter = 'ALL';

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø³Ø­Ø¨
    const sortable = new Sortable(document.getElementById('appsList'), {
        handle: '.drag-handle',
        animation: 150,
        onEnd: function (evt) { saveOrder(); }
    });

    function saveOrder() {
        if(currentFilter !== 'ALL') return; // Ø­Ù…Ø§ÙŠØ©: Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
        const items = document.querySelectorAll('.app-item');
        const updates = {};
        items.forEach((item, index) => {
            const key = item.getAttribute('data-key');
            updates[`apps/${key}/order`] = index;
        });
        update(ref(db), updates).then(() => msg("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨"));
    }

    onAuthStateChanged(auth, (user) => {
        if (user && user.uid === myUID) {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('adminArea').style.display = 'block';
            loadData();
        }
    });

    window.login = () => signInWithPopup(auth, provider);

    // Ø¯Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© (Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©)
    window.setFilter = (filter, btn) => {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ "Ø§Ù„ÙƒÙ„"
        const sortHint = document.getElementById('dragHint');
        if (filter === 'ALL') {
            sortable.option("disabled", false);
            sortHint.innerText = "ğŸ’¡ Ø§Ø³Ø­Ø¨ â˜° Ù„Ù„ØªØ±ØªÙŠØ¨";
            sortHint.style.color = "#f59e0b";
        } else {
            sortable.option("disabled", true);
            sortHint.innerText = "ğŸš« Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…ØªØ§Ø­ ÙÙ‚Ø· ÙÙŠ Ù‚Ø³Ù… (Ø§Ù„ÙƒÙ„)";
            sortHint.style.color = "#64748b";
        }
        renderList();
    };

    window.processImage = () => {
        const file = document.getElementById('fileInput').files[0];
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const scale = 200 / img.width;
                    canvas.width = 200; canvas.height = img.height * scale;
                    canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
                    currentImgBase64 = canvas.toDataURL("image/jpeg", 0.7);
                    document.getElementById('previewImg').src = currentImgBase64;
                    document.getElementById('previewImg').style.display = 'block';
                }
            }
        }
    };

    window.handleProcess = async () => {
        const name = document.getElementById('appName').value;
        const link = document.getElementById('appLink').value;
        const type = document.getElementById('inputType').value;
        const btn = document.getElementById('saveBtn');

        if (!name || !link) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        btn.disabled = true; btn.innerText = "â³...";

        try {
            const data = { 
                name, link, type, 
                img: currentImgBase64 || "https://cdn-icons-png.flaticon.com/512/564/564619.png",
                order: 0,
                isHidden: false
            };

            if (editKey) {
                await update(ref(db, 'apps/' + editKey), data);
                msg("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
            } else {
                await push(ref(db, 'apps'), data);
                msg("ğŸš€ ØªÙ… Ø§Ù„Ù†Ø´Ø±");
            }
            resetForm();
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); }
        btn.disabled = false; btn.innerText = "ğŸš€ Ø­ÙØ¸ ÙˆÙ†Ø´Ø±";
    };

    function loadData() {
        onValue(ref(db, 'apps'), (s) => {
            allDataCache = s.val() || {};
            renderList();
        });
    }

    function renderList() {
        const list = document.getElementById('appsList');
        list.innerHTML = "";
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Order
        const sortedArray = Object.entries(allDataCache).sort(([,a], [,b]) => {
            return (a.order || 0) - (b.order || 0);
        });

        sortedArray.forEach(([k, v]) => {
            // Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø©
            if (currentFilter === 'ALL' || v.type === currentFilter) {
                const isHidden = v.isHidden === true;
                const dragClass = currentFilter === 'ALL' ? 'drag-handle' : 'drag-handle drag-disabled';
                
                const div = document.createElement('div');
                div.className = `app-item ${isHidden ? 'hidden-item' : ''}`;
                div.setAttribute('data-key', k);
                div.innerHTML = `
                    <span class="${dragClass}">â˜°</span>
                    ${isSelectMode ? `<input type="checkbox" class="select-check" style="display:block" onchange="toggleItem('${k}', this)">` : ''}
                    <div style="display:flex; align-items:center; gap:10px; flex-grow:1; margin-right:10px;">
                        <img src="${v.img}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                        <div style="text-align:right;">
                            <strong>${v.name}</strong> ${isHidden ? '<small>ğŸ‘ï¸â€ğŸ—¨ï¸</small>' : ''}<br>
                            <span style="font-size:0.7rem; color:#94a3b8;">${v.type}</span>
                        </div>
                    </div>
                    <button onclick="startEdit('${k}','${v.name}','${v.link}','${v.img}','${v.type}')" style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:8px;">âœï¸</button>
                `;
                list.appendChild(div);
            }
        });
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if (isSelectMode) {
            document.querySelectorAll('.select-check').forEach(cb => {
                const key = cb.getAttribute('onchange').match(/'([^']+)'/)[1];
                if (selectedItems.has(key)) cb.checked = true;
            });
        }
    }

    window.toggleSelectionMode = () => {
        isSelectMode = !isSelectMode;
        selectedItems.clear();
        const bar = document.getElementById('bulkActionsBar');
        if (isSelectMode) bar.classList.add('visible'); else bar.classList.remove('visible');
        renderList();
    };

    window.toggleItem = (k, cb) => {
        if(cb.checked) selectedItems.add(k); else selectedItems.delete(k);
    };

    window.bulkDelete = async () => {
        if(confirm(`Ø­Ø°Ù ${selectedItems.size} Ø¹Ù†ØµØ±ØŸ`)) {
            const updates = {};
            selectedItems.forEach(k => updates[`apps/${k}`] = null);
            await update(ref(db), updates);
            msg("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
            toggleSelectionMode();
        }
    };

    window.bulkToggleVisibility = async () => {
        const updates = {};
        selectedItems.forEach(k => {
            updates[`apps/${k}/isHidden`] = !allDataCache[k].isHidden;
        });
        await update(ref(db), updates);
        msg("ğŸ‘ï¸ ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±");
        toggleSelectionMode();
    };

    window.startEdit = (k, n, l, i, t) => {
        editKey = k; currentImgBase64 = i;
        document.getElementById('appName').value = n;
        document.getElementById('appLink').value = l;
        document.getElementById('inputType').value = t;
        document.getElementById('previewImg').src = i;
        document.getElementById('previewImg').style.display = 'block';
        document.getElementById('saveBtn').innerText = "Ø­ÙØ¸";
        document.getElementById('cancelBtn').style.display = 'inline-block';
        window.scrollTo(0,0);
    };

    window.resetForm = () => {
        editKey = null; currentImgBase64 = "";
        document.getElementById('appName').value = '';
        document.getElementById('appLink').value = '';
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('saveBtn').innerText = "ğŸš€ Ø­ÙØ¸ ÙˆÙ†Ø´Ø±";
        document.getElementById('cancelBtn').style.display = 'none';
    };

    function msg(t) { const x = document.getElementById("toast"); x.innerText = t; x.className = "show"; setTimeout(() => x.className = "", 3000); }
</script>
</body>
</html>
